\chapter{Billedbehandling}\label{cha:ip}
\section{Design}
Billedbehandlingen inddeles i to dele: Webcam og behandling af billedet.

\subsection{Webcam}
Webcam-delen sørger for at varetage forbindelsen til webcam, og herfra hentes rå billeder.

Der defineres et interface, \texttt{IImageSource}, som specificerer metoderne \texttt{init()}, som benyttes til at forbinde til webcam -- \texttt{close()}, som lukker forbindelsen til webcam -- samt \texttt{getImage()}, som returnerer et billede fra webcam som et \texttt{BufferedImage} objekt.

Til at håndtere selve fobinddelsen til kameraet benyttes JMF \rec{cite}.

\begin{comment}
Opbygning
	Webcam -> behandling
	JMF
\end{comment}

\subsection{Billedbehandling}
Billedbehandlingen behandler billedet fra kameraet og bestemmer positioner af forhindringer, kager og robotter, nærmere bestemt:
\begin{description}
	\item[Fortolkning af kildebillede] til et \textit{tilemap\footnote{Tilemap er et 2D-array af integers, som er opbygget som et billede med meget få farver (én farve pr. genkendt objekttype)}}. Hver pixel undersøges i forhold til fastsatte grænseværdier.
	\item[Filtrering] af tilemap, hvor områder af pixels sorteres fra, hvis ikke de dækker et tilstrækkelig stort antal sammenhængende pixels. Dette fjerner støj fra billedet, og sikrer mod fejlagtig genkendelse af objekter.
	\item[Bestemmelse af grænser] for banen ud fra de 4 hjørne-forhindringer.
	\item[Generering af map af forhindringer], hvor der er tilføjet buffer-zoner omkring forhindringer. Hvis det ønskes, kan robot 2 her markeres, ligeledes med en buffer-zone, i tilfælde, hvor robot 1 skal finde vej uden om.
	\item[Bestemmelse af position] for kager.
	\item[Bestemmelse af position og vinkel] for robotter.
	\item[Skalering af output] for at optimere køretiden for stifindingen. Denne funktionalitet er ikke taget i brug.
	\item[Generering af grafisk repræsentation] af de behandlede data, så det er muligt at følge billedbehandlingens arbejde løbende.
\end{description}

\subsubsection{Opbygning}
Der er specificeret et interface -- \texttt{IImageProcessor} -- som billedbehandlingen skal implementere. I dette interface lægges også standard-værdier for mange af de parametre, som billedbehandlingen gør brug af.

Selve billedbehandlingen er implementeret i \texttt{ImageProcessor2} klassen. \rec{Forklaring på 2?} Al funktionalitet er specificeret her.

Data, som skal benyttes videre i det samlede system, returneres i DTO\footnote{Data Transfer Object} klassen \texttt{Locations}, som implementerer \texttt{ILocations} interfacet. Disse entiteter er rent databærende.\\
\texttt{ILocations} gemmer tilemap og forhindrings map som 2D int-arrays, og kager og robotter gemmes som lister af hhv. \texttt{Cake}- og \texttt{Robot} DTO-objekter. Kildebillede og fortolket billedet gemmes som \texttt{BufferedImage} objekter.

\section{Implementering}
\subsection{Webcam}
Der benyttes fortrinsvis JMF til hele implementeringen af webcam forbindelsen. Implementeringen tager udgangspunkt i det eksempel, som er givet på CampusNet. \rec{Ref?}\\
I \texttt{init()} metoden oprettes der forbindelse til enheden "`vfw:Microsoft WDM Image Capture (Win32):0"'. Der benyttes formatet 320x240 RGB.

Selve forbindelsen bruges gennem et statisk \texttt{Player} objekt.

\subsection{Billedbehandling}
I billedbehandlingen ligger klassevariable med tilhørende get-/set-metoder til de parametre, som er specificeret i \texttt{IImageProcessor}.

\paragraph{\texttt{examineImage(...)}}
Denne metode benyttes, når et billede skal behandles. Metoden tager som argumenter det kildebillede (et \texttt{BufferedImage}), som skal behandles, samt en boolsk værdi, som dikterer, hvorvidt en grafisk repræsentation af det behandlede billede skal dannes.\\
Metoden returnerer et \texttt{Locations} objekt.

\texttt{examineImage(...)} benytter de øvrige metoder i billedbehandlingen til at behandle det givne kildebillede.

\paragraph{\texttt{generateTilemap()}}
Her dannes ud fra kildebilledet et 2D-array med samme størrelse. Hver pixel undersøges i forhold til \rec{\texttt{Threshold}} objekter. Der tjekkes i rækkefølgen \textit{forhindring}, \textit{kage}, \textit{robot 1 (front-bag)}, \textit{robot2 (front-bag)}. Hvis ikke en pixel bliver genkendt her, tolkes den som værende baggrund/gulv.\\
Metoden gemmer det resulterende \textit{tilemap} i klasse-variablen \texttt{tilemap}.

\paragraph{\texttt{filterObstacles()}}
Filtrering af forhindrings-pixels foregår her. Samtidig foretages første generering af forhindrings map -- endnu et 2D-array, \texttt{obstaclemap}, med samme størrelse som \texttt{tilemap}.\\
Der benyttes endnu et 2D-array til at holde styr på behandlede pixels.

Metoden vandrer igennem alle pixels i \texttt{tilemap}. Hver gang en forhindring, som ikke allerede er behandlet, registreres, benyttes hjælpemetoden \rec{\texttt{collectRecursion()}} til at samle alle de sammenhængende forhindrings-pixels.\\
Hvis antallet af opsamlede koordinater er mindre end grænsen \texttt{MIN\_OBJECT\_SIZE}, forkastes forhindringen, og de fundne pixels defineres som baggrund i \texttt{tilemap} og \texttt{obstaclemap}.\\
I modsat fald -- hvis den opsamlede forhindring er tilstrækkelig stor -- registreres de opsamlede punkter i \texttt{obstaclemap}.

\paragraph{\texttt{findBounds()}}
Grænserne for selve banen bestemmes groft ved at finde den øverste og nederste vandrette linje i \texttt{tilemap}, hvor der er min. 5 forhindrings-pixels. Tilsvarende gælder for lodrette linjer mod venstre og højre.

De fundne grænseværdier gemmes som \texttt{int}-array på formen \textit{$\left\{\right.$ top, venstre, bund, højre $\left.\right\}$} i klasse-variablen \texttt{bounds}, den statiske variabel \texttt{stageBounds}, foruden at de returneres.

\paragraph{\texttt{processTilemap()}}
Her foretages den egentlige tolkning af \texttt{tilemap}, og her ligger billedbehandlingens store ressourceforbrug.\\
Igen benyttes et 2D-array til registrering af behandlede pixels.

Metoden vandrer gennem pixels. For at minimere køretiden er her indført en opløsning, så kun hver 3. linje og hver 3. pixel på linjerne behandles umiddelbart.

Hvis en \textit{forhindrings}-pixel registreres, registreres denne i \texttt{obstaclemap} med \texttt{obstacleBuffer} værdien, og pixels omkring denne med \texttt{obstacleBuffer} fratrukket afstanden til den behandlede pixel -- såfremt der ikke allerede er en højere værdi. Herved opnås et forhindrings map, hvor forhindringer har en høj værdi, og pixels nær forhindringerne får en lavere værdi, jo længere væk de er fra forhindringen.

Ved \textit{kage}-pixels benyttes hjælpemetoden \texttt{collect(...)} til at bestemme center-positionen for kagen. Der tjekkes, hvorvidt positionen er inden for banens grænser -- og hvis det er tilfældet, oprettes et \texttt{Cake} objekt, som føjes til \texttt{cakes} listen.

Pixels, som tilhører en af robotterne benytter ligeledes \texttt{collect(...)} til at bestemme center-koordinaten for farven. Disse koordinater gemmes til senere brug.\\
I tilfælde, hvor robotterne kommer i nærheden af hinanden, skal robot 1 kunne finde uden om robot 2. Dette er der forberedt for ved flaget \texttt{robotYield}. Hvis dette er sat, vil alle pixels, som tilhører robot 2 -- plus bufferzone omkring -- få værdien -1 i \texttt{obstaclemap}.

Efter alle pixels er behandlet, samles robotternes informationer. En robot, hvis position ikke kan bestemmes ud fra de fundne informationer oprettes med positionen $(-1,-1)$.\\
Hvis en robot kan findes, bestemmes dens position som gennemsnittet af front og bag -- og vinklen bestemmes med \texttt{calculateAngle(...)}.\\
Begge robotter -- uanset om de kunne findes eller ej -- føjes til \texttt{robots} listen.

\paragraph{\texttt{scaleMaps(...)}}
Denne metode skalerer \texttt{tilemap} og \texttt{obstaclemap} ned. Dette er ikke ibrugtaget, men forberedt aht. at kunne reducere køretiden på stifindingen.\\
I andre metoder bliver skaleringen også håndteret ved udregning af koordinater -- her divideres med skaleringsfaktoren \texttt{outputScale}.

\paragraph{\texttt{createTileImage()}}
Her genereres et \texttt{BufferedImage}, som giver en grafisk repræsentation af \texttt{tilemap} og \texttt{obstaclemap}.

Værdierne fra \texttt{obstaclemap} vises som gule gradueringer, hvor højere værdi giver kraftigere farve. Selve forhindringerne, kagerne og robotterne vises ud fra deres registreringer i \texttt{tilemap} med farver, der nogenlunde matcher deres egentlige farver.\\
Banens grænser vises som en cyan firkant.
\begin{comment}
Webcam
	mode
	player?
	
Processor
	Thresholds
	Resolution
\end{comment}

\section{Test}

\section{Udviklingsproces}

\begin{comment}
	
Webcam
	Varetager forbindelse til webcam
	Henter BufferedImage i 320x240

Processor
	Billede ind som BufferedImage
	Parse til 2D-array
	Filtrering
	Optimering i walker
	Objekt-/robot ID
	Obstacle map
	Grafisk repræsentation
	Scaling (ej i brug)
	Returnerer Locations objekt til brug i pathfinder
	
Udviklingsproces
	Simpelt udgangspunkt
	Løbende tilføjet funktionalitet med behov fra stifinding
	Efter første full cycle udviklet i version 2 med optimeringer
	
Test
	Program t visuel test
	"Webcam-simulator"
	Benchmark kørsler, resultater
	Performance udvikling
\end{comment}